// Backbone.js 0.9.2

// (c) 2010-2012 Jeremy Ashkenas, DocumentCloud Inc.
// Backbone may be freely distributed under the MIT license.
// For all details and documentation:
// http://backbonejs.org
(function(){var t=this;var e=t.Backbone;var i=Array.prototype.slice;var s=Array.prototype.splice;var r;if(typeof exports!=="undefined"){r=exports}else{r=t.Backbone={}}r.VERSION="0.9.2";var n=t._;if(!n&&typeof require!=="undefined")n=require("underscore");var a=t.jQuery||t.Zepto||t.ender;r.setDomLibrary=function(t){a=t};r.noConflict=function(){t.Backbone=e;return this};r.emulateHTTP=false;r.emulateJSON=false;var o=/\s+/;var h=r.Events={on:function(t,e,i){var s,r,n,a,h;if(!e)return this;t=t.split(o);s=this._callbacks||(this._callbacks={});while(r=t.shift()){h=s[r];n=h?h.tail:{};n.next=a={};n.context=i;n.callback=e;s[r]={tail:a,next:h?h.next:n}}return this},off:function(t,e,i){var s,r,a,h,u,l;if(!(r=this._callbacks))return;if(!(t||e||i)){delete this._callbacks;return this}t=t?t.split(o):n.keys(r);while(s=t.shift()){a=r[s];delete r[s];if(!a||!(e||i))continue;h=a.tail;while((a=a.next)!==h){u=a.callback;l=a.context;if(e&&u!==e||i&&l!==i){this.on(s,u,l)}}}return this},trigger:function(t){var e,s,r,n,a,h,u;if(!(r=this._callbacks))return this;h=r.all;t=t.split(o);u=i.call(arguments,1);while(e=t.shift()){if(s=r[e]){n=s.tail;while((s=s.next)!==n){s.callback.apply(s.context||this,u)}}if(s=h){n=s.tail;a=[e].concat(u);while((s=s.next)!==n){s.callback.apply(s.context||this,a)}}}return this}};h.bind=h.on;h.unbind=h.off;var u=r.Model=function(t,e){var i;t||(t={});if(e&&e.parse)t=this.parse(t);if(i=A(this,"defaults")){t=n.extend({},i,t)}if(e&&e.collection)this.collection=e.collection;this.attributes={};this._escapedAttributes={};this.cid=n.uniqueId("c");this.changed={};this._silent={};this._pending={};this.set(t,{silent:true});this.changed={};this._silent={};this._pending={};this._previousAttributes=n.clone(this.attributes);this.initialize.apply(this,arguments)};n.extend(u.prototype,h,{changed:null,_silent:null,_pending:null,idAttribute:"id",initialize:function(){},toJSON:function(t){return n.clone(this.attributes)},get:function(t){return this.attributes[t]},escape:function(t){var e;if(e=this._escapedAttributes[t])return e;var i=this.get(t);return this._escapedAttributes[t]=n.escape(i==null?"":""+i)},has:function(t){return this.get(t)!=null},set:function(t,e,i){var s,r,a;if(n.isObject(t)||t==null){s=t;i=e}else{s={};s[t]=e}i||(i={});if(!s)return this;if(s instanceof u)s=s.attributes;if(i.unset)for(r in s)s[r]=void 0;if(!this._validate(s,i))return false;if(this.idAttribute in s)this.id=s[this.idAttribute];var o=i.changes={};var h=this.attributes;var l=this._escapedAttributes;var c=this._previousAttributes||{};for(r in s){a=s[r];if(!n.isEqual(h[r],a)||i.unset&&n.has(h,r)){delete l[r];(i.silent?this._silent:o)[r]=true}i.unset?delete h[r]:h[r]=a;if(!n.isEqual(c[r],a)||n.has(h,r)!=n.has(c,r)){this.changed[r]=a;if(!i.silent)this._pending[r]=true}else{delete this.changed[r];delete this._pending[r]}}if(!i.silent)this.change(i);return this},unset:function(t,e){(e||(e={})).unset=true;return this.set(t,null,e)},clear:function(t){(t||(t={})).unset=true;return this.set(n.clone(this.attributes),t)},fetch:function(t){t=t?n.clone(t):{};var e=this;var i=t.success;t.success=function(s,r,n){if(!e.set(e.parse(s,n),t))return false;if(i)i(e,s)};t.error=r.wrapError(t.error,e,t);return(this.sync||r.sync).call(this,"read",this,t)},save:function(t,e,i){var s,a;if(n.isObject(t)||t==null){s=t;i=e}else{s={};s[t]=e}i=i?n.clone(i):{};if(i.wait){if(!this._validate(s,i))return false;a=n.clone(this.attributes)}var o=n.extend({},i,{silent:true});if(s&&!this.set(s,i.wait?o:i)){return false}var h=this;var u=i.success;i.success=function(t,e,r){var a=h.parse(t,r);if(i.wait){delete i.wait;a=n.extend(s||{},a)}if(!h.set(a,i))return false;if(u){u(h,t)}else{h.trigger("sync",h,t,i)}};i.error=r.wrapError(i.error,h,i);var l=this.isNew()?"create":"update";var c=(this.sync||r.sync).call(this,l,this,i);if(i.wait)this.set(a,o);return c},destroy:function(t){t=t?n.clone(t):{};var e=this;var i=t.success;var s=function(){e.trigger("destroy",e,e.collection,t)};if(this.isNew()){s();return false}t.success=function(r){if(t.wait)s();if(i){i(e,r)}else{e.trigger("sync",e,r,t)}};t.error=r.wrapError(t.error,e,t);var a=(this.sync||r.sync).call(this,"delete",this,t);if(!t.wait)s();return a},url:function(){var t=A(this,"urlRoot")||A(this.collection,"url")||C();if(this.isNew())return t;return t+(t.charAt(t.length-1)=="/"?"":"/")+encodeURIComponent(this.id)},parse:function(t,e){return t},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return this.id==null},change:function(t){t||(t={});var e=this._changing;this._changing=true;for(var i in this._silent)this._pending[i]=true;var s=n.extend({},t.changes,this._silent);this._silent={};for(var i in s){this.trigger("change:"+i,this,this.get(i),t)}if(e)return this;while(!n.isEmpty(this._pending)){this._pending={};this.trigger("change",this,t);for(var i in this.changed){if(this._pending[i]||this._silent[i])continue;delete this.changed[i]}this._previousAttributes=n.clone(this.attributes)}this._changing=false;return this},hasChanged:function(t){if(!arguments.length)return!n.isEmpty(this.changed);return n.has(this.changed,t)},changedAttributes:function(t){if(!t)return this.hasChanged()?n.clone(this.changed):false;var e,i=false,s=this._previousAttributes;for(var r in t){if(n.isEqual(s[r],e=t[r]))continue;(i||(i={}))[r]=e}return i},previous:function(t){if(!arguments.length||!this._previousAttributes)return null;return this._previousAttributes[t]},previousAttributes:function(){return n.clone(this._previousAttributes)},isValid:function(){return!this.validate(this.attributes)},_validate:function(t,e){if(e.silent||!this.validate)return true;t=n.extend({},this.attributes,t);var i=this.validate(t,e);if(!i)return true;if(e&&e.error){e.error(this,i,e)}else{this.trigger("error",this,i,e)}return false}});var l=r.Collection=function(t,e){e||(e={});if(e.model)this.model=e.model;if(e.comparator)this.comparator=e.comparator;this._reset();this.initialize.apply(this,arguments);if(t)this.reset(t,{silent:true,parse:e.parse})};n.extend(l.prototype,h,{model:u,initialize:function(){},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},add:function(t,e){var i,r,a,o,h,u,l={},c={},f=[];e||(e={});t=n.isArray(t)?t.slice():[t];for(i=0,a=t.length;i<a;i++){if(!(o=t[i]=this._prepareModel(t[i],e))){throw new Error("Can't add an invalid model to a collection")}h=o.cid;u=o.id;if(l[h]||this._byCid[h]||u!=null&&(c[u]||this._byId[u])){f.push(i);continue}l[h]=c[u]=o}i=f.length;while(i--){t.splice(f[i],1)}for(i=0,a=t.length;i<a;i++){(o=t[i]).on("all",this._onModelEvent,this);this._byCid[o.cid]=o;if(o.id!=null)this._byId[o.id]=o}this.length+=a;r=e.at!=null?e.at:this.models.length;s.apply(this.models,[r,0].concat(t));if(this.comparator)this.sort({silent:true});if(e.silent)return this;for(i=0,a=this.models.length;i<a;i++){if(!l[(o=this.models[i]).cid])continue;e.index=i;o.trigger("add",o,this,e)}return this},remove:function(t,e){var i,s,r,a;e||(e={});t=n.isArray(t)?t.slice():[t];for(i=0,s=t.length;i<s;i++){a=this.getByCid(t[i])||this.get(t[i]);if(!a)continue;delete this._byId[a.id];delete this._byCid[a.cid];r=this.indexOf(a);this.models.splice(r,1);this.length--;if(!e.silent){e.index=r;a.trigger("remove",a,this,e)}this._removeReference(a)}return this},push:function(t,e){t=this._prepareModel(t,e);this.add(t,e);return t},pop:function(t){var e=this.at(this.length-1);this.remove(e,t);return e},unshift:function(t,e){t=this._prepareModel(t,e);this.add(t,n.extend({at:0},e));return t},shift:function(t){var e=this.at(0);this.remove(e,t);return e},get:function(t){if(t==null)return void 0;return this._byId[t.id!=null?t.id:t]},getByCid:function(t){return t&&this._byCid[t.cid||t]},at:function(t){return this.models[t]},where:function(t){if(n.isEmpty(t))return[];return this.filter(function(e){for(var i in t){if(t[i]!==e.get(i))return false}return true})},sort:function(t){t||(t={});if(!this.comparator)throw new Error("Cannot sort a set without a comparator");var e=n.bind(this.comparator,this);if(this.comparator.length==1){this.models=this.sortBy(e)}else{this.models.sort(e)}if(!t.silent)this.trigger("reset",this,t);return this},pluck:function(t){return n.map(this.models,function(e){return e.get(t)})},reset:function(t,e){t||(t=[]);e||(e={});for(var i=0,s=this.models.length;i<s;i++){this._removeReference(this.models[i])}this._reset();this.add(t,n.extend({silent:true},e));if(!e.silent)this.trigger("reset",this,e);return this},fetch:function(t){t=t?n.clone(t):{};if(t.parse===undefined)t.parse=true;var e=this;var i=t.success;t.success=function(s,r,n){e[t.add?"add":"reset"](e.parse(s,n),t);if(i)i(e,s)};t.error=r.wrapError(t.error,e,t);return(this.sync||r.sync).call(this,"read",this,t)},create:function(t,e){var i=this;e=e?n.clone(e):{};t=this._prepareModel(t,e);if(!t)return false;if(!e.wait)i.add(t,e);var s=e.success;e.success=function(r,n,a){if(e.wait)i.add(r,e);if(s){s(r,n)}else{r.trigger("sync",t,n,e)}};t.save(null,e);return t},parse:function(t,e){return t},chain:function(){return n(this.models).chain()},_reset:function(t){this.length=0;this.models=[];this._byId={};this._byCid={}},_prepareModel:function(t,e){e||(e={});if(!(t instanceof u)){var i=t;e.collection=this;t=new this.model(i,e);if(!t._validate(t.attributes,e))t=false}else if(!t.collection){t.collection=this}return t},_removeReference:function(t){if(this==t.collection){delete t.collection}t.off("all",this._onModelEvent,this)},_onModelEvent:function(t,e,i,s){if((t=="add"||t=="remove")&&i!=this)return;if(t=="destroy"){this.remove(e,s)}if(e&&t==="change:"+e.idAttribute){delete this._byId[e.previous(e.idAttribute)];this._byId[e.id]=e}this.trigger.apply(this,arguments)}});var c=["forEach","each","map","reduce","reduceRight","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","sortBy","sortedIndex","toArray","size","first","initial","rest","last","without","indexOf","shuffle","lastIndexOf","isEmpty","groupBy"];n.each(c,function(t){l.prototype[t]=function(){return n[t].apply(n,[this.models].concat(n.toArray(arguments)))}});var f=r.Router=function(t){t||(t={});if(t.routes)this.routes=t.routes;this._bindRoutes();this.initialize.apply(this,arguments)};var d=/:\w+/g;var p=/\*\w+/g;var g=/[-[\]{}()+?.,\\^$|#\s]/g;n.extend(f.prototype,h,{initialize:function(){},route:function(t,e,i){r.history||(r.history=new v);if(!n.isRegExp(t))t=this._routeToRegExp(t);if(!i)i=this[e];r.history.route(t,n.bind(function(s){var n=this._extractParameters(t,s);i&&i.apply(this,n);this.trigger.apply(this,["route:"+e].concat(n));r.history.trigger("route",this,e,n)},this));return this},navigate:function(t,e){r.history.navigate(t,e)},_bindRoutes:function(){if(!this.routes)return;var t=[];for(var e in this.routes){t.unshift([e,this.routes[e]])}for(var i=0,s=t.length;i<s;i++){this.route(t[i][0],t[i][1],this[t[i][1]])}},_routeToRegExp:function(t){t=t.replace(g,"\\$&").replace(d,"([^/]+)").replace(p,"(.*?)");return new RegExp("^"+t+"$")},_extractParameters:function(t,e){return t.exec(e).slice(1)}});var v=r.History=function(){this.handlers=[];n.bindAll(this,"checkUrl")};var m=/^[#\/]/;var _=/msie [\w.]+/;v.started=false;n.extend(v.prototype,h,{interval:50,getHash:function(t){var e=t?t.location:window.location;var i=e.href.match(/#(.*)$/);return i?i[1]:""},getFragment:function(t,e){if(t==null){if(this._hasPushState||e){t=window.location.pathname;var i=window.location.search;if(i)t+=i}else{t=this.getHash()}}if(!t.indexOf(this.options.root))t=t.substr(this.options.root.length);return t.replace(m,"")},start:function(t){if(v.started)throw new Error("Backbone.history has already been started");v.started=true;this.options=n.extend({},{root:"/"},this.options,t);this._wantsHashChange=this.options.hashChange!==false;this._wantsPushState=!!this.options.pushState;this._hasPushState=!!(this.options.pushState&&window.history&&window.history.pushState);var e=this.getFragment();var i=document.documentMode;var s=_.exec(navigator.userAgent.toLowerCase())&&(!i||i<=7);if(s){this.iframe=a('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow;this.navigate(e)}if(this._hasPushState){a(window).bind("popstate",this.checkUrl)}else if(this._wantsHashChange&&"onhashchange"in window&&!s){a(window).bind("hashchange",this.checkUrl)}else if(this._wantsHashChange){this._checkUrlInterval=setInterval(this.checkUrl,this.interval)}this.fragment=e;var r=window.location;var o=r.pathname==this.options.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!o){this.fragment=this.getFragment(null,true);window.location.replace(this.options.root+"#"+this.fragment);return true}else if(this._wantsPushState&&this._hasPushState&&o&&r.hash){this.fragment=this.getHash().replace(m,"");window.history.replaceState({},document.title,r.protocol+"//"+r.host+this.options.root+this.fragment)}if(!this.options.silent){return this.loadUrl()}},stop:function(){a(window).unbind("popstate",this.checkUrl).unbind("hashchange",this.checkUrl);clearInterval(this._checkUrlInterval);v.started=false},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(t){var e=this.getFragment();if(e==this.fragment&&this.iframe)e=this.getFragment(this.getHash(this.iframe));if(e==this.fragment)return false;if(this.iframe)this.navigate(e);this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(t){var e=this.fragment=this.getFragment(t);var i=n.any(this.handlers,function(t){if(t.route.test(e)){t.callback(e);return true}});return i},navigate:function(t,e){if(!v.started)return false;if(!e||e===true)e={trigger:e};var i=(t||"").replace(m,"");if(this.fragment==i)return;if(this._hasPushState){if(i.indexOf(this.options.root)!=0)i=this.options.root+i;this.fragment=i;window.history[e.replace?"replaceState":"pushState"]({},document.title,i)}else if(this._wantsHashChange){this.fragment=i;this._updateHash(window.location,i,e.replace);if(this.iframe&&i!=this.getFragment(this.getHash(this.iframe))){if(!e.replace)this.iframe.document.open().close();this._updateHash(this.iframe.location,i,e.replace)}}else{window.location.assign(this.options.root+t)}if(e.trigger)this.loadUrl(t)},_updateHash:function(t,e,i){if(i){t.replace(t.toString().replace(/(javascript:|#).*$/,"")+"#"+e)}else{t.hash=e}}});var y=r.View=function(t){this.cid=n.uniqueId("view");this._configure(t||{});this._ensureElement();this.initialize.apply(this,arguments);this.delegateEvents()};var w=/^(\S+)\s*(.*)$/;var b=["model","collection","el","id","attributes","className","tagName"];n.extend(y.prototype,h,{tagName:"div",$:function(t){return this.$el.find(t)},initialize:function(){},render:function(){return this},remove:function(){this.$el.remove();return this},make:function(t,e,i){var s=document.createElement(t);if(e)a(s).attr(e);if(i)a(s).html(i);return s},setElement:function(t,e){if(this.$el)this.undelegateEvents();this.$el=t instanceof a?t:a(t);this.el=this.$el[0];if(e!==false)this.delegateEvents();return this},delegateEvents:function(t){if(!(t||(t=A(this,"events"))))return;this.undelegateEvents();for(var e in t){var i=t[e];if(!n.isFunction(i))i=this[t[e]];if(!i)throw new Error('Method "'+t[e]+'" does not exist');var s=e.match(w);var r=s[1],a=s[2];i=n.bind(i,this);r+=".delegateEvents"+this.cid;if(a===""){this.$el.bind(r,i)}else{this.$el.delegate(a,r,i)}}},undelegateEvents:function(){this.$el.unbind(".delegateEvents"+this.cid)},_configure:function(t){if(this.options)t=n.extend({},this.options,t);for(var e=0,i=b.length;e<i;e++){var s=b[e];if(t[s])this[s]=t[s]}this.options=t},_ensureElement:function(){if(!this.el){var t=A(this,"attributes")||{};if(this.id)t.id=this.id;if(this.className)t["class"]=this.className;this.setElement(this.make(this.tagName,t),false)}else{this.setElement(this.el,false)}}});var x=function(t,e){var i=k(this,t,e);i.extend=this.extend;return i};u.extend=l.extend=f.extend=y.extend=x;var E={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};r.sync=function(t,e,i){var s=E[t];i||(i={});var o={type:s,dataType:"json"};if(!i.url){o.url=A(e,"url")||C()}if(!i.data&&e&&(t=="create"||t=="update")){o.contentType="application/json";o.data=JSON.stringify(e.toJSON())}if(r.emulateJSON){o.contentType="application/x-www-form-urlencoded";o.data=o.data?{model:o.data}:{}}if(r.emulateHTTP){if(s==="PUT"||s==="DELETE"){if(r.emulateJSON)o.data._method=s;o.type="POST";o.beforeSend=function(t){t.setRequestHeader("X-HTTP-Method-Override",s)}}}if(o.type!=="GET"&&!r.emulateJSON){o.processData=false}return a.ajax(n.extend(o,i))};r.wrapError=function(t,e,i){return function(s,r){r=s===e?r:s;if(t){t(e,r,i)}else{e.trigger("error",e,r,i)}}};var S=function(){};var k=function(t,e,i){var s;if(e&&e.hasOwnProperty("constructor")){s=e.constructor}else{s=function(){t.apply(this,arguments)}}n.extend(s,t);S.prototype=t.prototype;s.prototype=new S;if(e)n.extend(s.prototype,e);if(i)n.extend(s,i);s.prototype.constructor=s;s.__super__=t.prototype;return s};var A=function(t,e){if(!(t&&t[e]))return null;return n.isFunction(t[e])?t[e]():t[e]};var C=function(){throw new Error('A "url" property or function must be specified')}}).call(this);